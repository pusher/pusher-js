#!/bin/bash

set -euo pipefail

root="$( cd "$( dirname "${BASH_SOURCE[0]}" )"/.. > /dev/null && pwd )"

# clean up build artifacts (for submodule to be happy)
cd $root/src/web-socket-js
rm -f WebSocketMain.swf WebSocketMainInsecure.swf

# update the submodules
cd $root
git submodule update --init

# build web-socket-js (use our sane build script)
$root/bin/build-web-socket-js.sh

# build sockjs
cd $root/src/sockjs
npm i
make

# jbundle all the things
cd $root
bundle exec jbundle
